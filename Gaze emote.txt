-- LocalScript inside StarterGui

-- Services setup
function missing(t, f, fallback)
    if type(f) == t then return f end
    return fallback 
end

cloneref = missing("function", cloneref, function(...) return ... end)

local Services = setmetatable({}, {
    __index = function(_, name)
        return cloneref(game:GetService(name))
    end
})

local Players = Services.Players
local RunService = Services.RunService
local UserInputService = Services.UserInputService
local TweenService = Services.TweenService
local AvatarEditorService = Services.AvatarEditorService

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local lastPosition = character.PrimaryPart and character.PrimaryPart.Position or Vector3.new()

player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = newCharacter:WaitForChild("Humanoid")
    lastPosition = character.PrimaryPart and character.PrimaryPart.Position or Vector3.new()
end)

-- Settings
local Settings = _G
Settings["Stop On Move"] = true
Settings["Fade In"]     = 0.1
Settings["Fade Out"]    = 0.1
Settings["Weight"]      = 1
Settings["Speed"]       = 1
Settings["Allow Invisible"]    = true
Settings["Time Position"] = 0

-- Animation track management
local CurrentTrack = nil

local function LoadTrack(id)
    if CurrentTrack then 
        CurrentTrack:Stop(Settings["Fade Out"]) 
    end
    
    local animId
    local ok, result = pcall(function() 
        return game:GetObjects("rbxassetid://" .. tostring(id)) 
    end)
    
    if ok and result and #result > 0 then
        local anim = result[1]
        if anim:IsA("Animation") then
            animId = anim.AnimationId
        else
            animId = "rbxassetid://" .. tostring(id)
        end
    else
        animId = "rbxassetid://" .. tostring(id)
    end
    
    local newAnim = Instance.new("Animation")
    newAnim.AnimationId = animId
    local newTrack = humanoid:LoadAnimation(newAnim)
    newTrack.Priority = Enum.AnimationPriority.Action4
    
    local weight = Settings["Weight"]
    if weight == 0 then weight = 0.001 end
    
    newTrack:Play(Settings["Fade In"], weight, Settings["Speed"])
    CurrentTrack = newTrack
    CurrentTrack.TimePosition = math.clamp(Settings["Time Position"], 0, 1) * CurrentTrack.Length
    
    return newTrack
end

-- Stop on move functionality
RunService.RenderStepped:Connect(function()
    if character.PrimaryPart then
        if Settings["Stop On Move"] and CurrentTrack and CurrentTrack.IsPlaying then
            local moved = (character.PrimaryPart.Position - lastPosition).Magnitude > 0.1
            local jumped = humanoid and humanoid:GetState() == Enum.HumanoidStateType.Jumping
            
            if moved or jumped then
                CurrentTrack:Stop(Settings["Fade Out"])
                CurrentTrack = nil
            end
        end
        lastPosition = character.PrimaryPart.Position
    end
end)

-- === GUI ===
local CoreGui = Services.CoreGui
local gui = Instance.new("ScreenGui")
gui.Name = "GazeEmoteGUI"
gui.Parent = CoreGui
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Create a background gradient function
local function createGradient(parent, colorSequence)
    
    return 
end

-- Create a rounded corner function
local function createCorner(parent, cornerRadius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, cornerRadius)
    corner.Parent = parent
    return corner
end

-- Main container frame
local mainContainer = Instance.new("Frame")
mainContainer.Size = UDim2.new(0, 600, 0, 400)
mainContainer.Position = UDim2.new(0.5, -400, 0.5, -250)
mainContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainContainer.Active = true
mainContainer.Draggable = true
mainContainer.Parent = gui

-- Apply gradient and corner to main container
createGradient(mainContainer, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 35)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 25))
})
createCorner(mainContainer, 12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 36)
title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
title.Text = "Gaze Emotes"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = mainContainer

-- Apply gradient and corner to title
createGradient(title, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(60, 60, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 40))
})
createCorner(title, 8)

-- Divider between catalog and settings
local divider = Instance.new("Frame")
divider.Size = UDim2.new(0, 2, 1, -40)
divider.Position = UDim2.new(0.6, -1, 0, 36)
divider.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
divider.Parent = mainContainer
createCorner(divider, 1)

-- Catalog section
local catalogFrame = Instance.new("Frame")
catalogFrame.Size = UDim2.new(0.6, -10, 1, -40)
catalogFrame.Position = UDim2.new(0, 5, 0, 40)
catalogFrame.BackgroundTransparency = 1
catalogFrame.Parent = mainContainer

-- Search box
local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(0.6, -8, 0, 28)
searchBox.Position = UDim2.new(0, 8, 0, 0)
searchBox.PlaceholderText = "Search..."
searchBox.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.Font = Enum.Font.Gotham
searchBox.TextScaled = true
searchBox.ClearTextOnFocus = false
searchBox.Parent = catalogFrame

-- Apply gradient and corner to search box
createGradient(searchBox, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 40)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 25))
})
createCorner(searchBox, 6)

-- Search button
local searchBtn = Instance.new("TextButton")
searchBtn.Size = UDim2.new(0.2, -4, 0, 28)
searchBtn.Position = UDim2.new(0.6, 4, 0, 0)
searchBtn.BackgroundColor3 = Color3.fromRGB(60, 130, 60)
searchBtn.Text = "Search"
searchBtn.Font = Enum.Font.GothamBold
searchBtn.TextScaled = true
searchBtn.TextColor3 = Color3.new(1, 1, 1)
searchBtn.Parent = catalogFrame

-- Apply gradient and corner to search button
createGradient(searchBtn, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 160, 80)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 110, 50))
})
createCorner(searchBtn, 6)

-- Sort button
local sortBtn = Instance.new("TextButton")
sortBtn.Size = UDim2.new(0.2, -8, 0, 28)
sortBtn.Position = UDim2.new(0.8, 4, 0, 0)
sortBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 120)
sortBtn.Text = "Sort: Relevance"
sortBtn.Font = Enum.Font.GothamBold
sortBtn.TextScaled = true
sortBtn.TextColor3 = Color3.new(1, 1, 1)
sortBtn.Parent = catalogFrame

-- Apply gradient and corner to sort button
createGradient(sortBtn, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(90, 90, 150)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(60, 60, 100))
})
createCorner(sortBtn, 6)

-- Scroll frame for catalog items
local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.new(1, -16, 1, -100)
scroll.Position = UDim2.new(0, 8, 0, 36)
scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
scroll.ScrollBarThickness = 6
scroll.BackgroundTransparency = 1
scroll.Parent = catalogFrame

-- Empty results label
local emptyLabel = Instance.new("TextLabel")
emptyLabel.Size = UDim2.new(1, 0, 0, 36)
emptyLabel.Position = UDim2.new(0, 0, 0.5, -18)
emptyLabel.BackgroundTransparency = 1
emptyLabel.Text = "Nothing Silly Here :3 (except me)"
emptyLabel.TextColor3 = Color3.new(1, 1, 1)
emptyLabel.Font = Enum.Font.GothamBold
emptyLabel.TextScaled = true
emptyLabel.Visible = false
emptyLabel.Parent = scroll

local layout = Instance.new("UIGridLayout")
layout.CellSize = UDim2.new(0, 120, 0, 160)
layout.CellPadding = UDim2.new(0, 8, 0, 8)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.Parent = scroll

-- Navigation buttons
local prevBtn = Instance.new("TextButton")
prevBtn.Size = UDim2.new(0.4, -6, 0, 32)
prevBtn.Position = UDim2.new(0, 4, 1, -36)
prevBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
prevBtn.Text = "< Prev"
prevBtn.Font = Enum.Font.GothamBold
prevBtn.TextScaled = true
prevBtn.TextColor3 = Color3.new(1, 1, 1)
prevBtn.Parent = catalogFrame

-- Apply gradient and corner to prev button
createGradient(prevBtn, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 120, 120)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 80))
})
createCorner(prevBtn, 6)

local nextBtn = Instance.new("TextButton")
nextBtn.Size = UDim2.new(0.4, -6, 0, 32)
nextBtn.Position = UDim2.new(0.6, 2, 1, -36)
nextBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
nextBtn.Text = "Next >"
nextBtn.Font = Enum.Font.GothamBold
nextBtn.TextScaled = true
nextBtn.TextColor3 = Color3.new(1, 1, 1)
nextBtn.Parent = catalogFrame

-- Apply gradient and corner to next button
createGradient(nextBtn, ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 120, 120)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 80))
})
createCorner(nextBtn, 6)

-- Page label
local pageLabel = Instance.new("TextLabel")
pageLabel.Size = UDim2.new(0.2, 0, 0, 32)
pageLabel.Position = UDim2.new(0.4, 2, 1, -36)
pageLabel.BackgroundTransparency = 1
pageLabel.Font = Enum.Font.Gotham
pageLabel.TextScaled = true
pageLabel.TextColor3 = Color3.new(1, 1, 1)
pageLabel.Text = "Page 1"
pageLabel.Parent = catalogFrame

-- Settings section
local settingsFrame = Instance.new("Frame")
settingsFrame.Size = UDim2.new(0.4, -10, 1, -40)
settingsFrame.Position = UDim2.new(0.6, 5, 0, 40)
settingsFrame.BackgroundTransparency = 1
settingsFrame.Parent = mainContainer

-- Settings title
local settingsTitle = Instance.new("TextLabel")
settingsTitle.Size = UDim2.new(1, 0, 0, 28)
settingsTitle.BackgroundTransparency = 1
settingsTitle.Text = "Settings"
settingsTitle.TextColor3 = Color3.new(1, 1, 1)
settingsTitle.Font = Enum.Font.GothamBold
settingsTitle.TextScaled = true
settingsTitle.Parent = settingsFrame

-- Settings scroll frame
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -20, 1, -40)
scrollFrame.Position = UDim2.new(0, 10, 0, 30)
scrollFrame.BackgroundTransparency = 1
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = settingsFrame

-- Lock horizontal scrolling
local function lockX()
    scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasPosition.Y)
end
scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(lockX)

-- Layout for settings
local listLayout = Instance.new("UIListLayout", scrollFrame)
listLayout.Padding = UDim.new(0, 6)
listLayout.FillDirection = Enum.FillDirection.Vertical
listLayout.SortOrder = Enum.SortOrder.LayoutOrder

listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
end)

-- Slider creator function
local function createSlider(name, min, max, default)
    Settings[name] = default or min

    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 65)
    container.BackgroundTransparency = 1
    container.Parent = scrollFrame

    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    bg.Parent = container
    Instance.new("UICorner", bg).CornerRadius = UDim.new(0, 8)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, -10, 0, 20)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = string.format("%s: %.2f", name, Settings[name])
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = bg

    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(0.5, -20, 0, 20)
    textBox.Position = UDim2.new(0.5, 10, 0, 5)
    textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    textBox.Text = tostring(Settings[name])
    textBox.TextColor3 = Color3.new(1, 1, 1)
    textBox.Font = Enum.Font.Gotham
    textBox.TextSize = 14
    textBox.ClearTextOnFocus = false
    textBox.Parent = bg
    Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, 6)

    local sliderBar = Instance.new("Frame")
    sliderBar.Size = UDim2.new(1, -40, 0, 12)
    sliderBar.Position = UDim2.new(0, 20, 0, 35)
    sliderBar.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    sliderBar.Parent = bg
    Instance.new("UICorner", sliderBar).CornerRadius = UDim.new(0, 6)

    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new(0, 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    sliderFill.Parent = sliderBar
    Instance.new("UICorner", sliderFill).CornerRadius = UDim.new(0, 6)

    local thumb = Instance.new("Frame")
    thumb.Size = UDim2.new(0, 20, 0, 20)
    thumb.AnchorPoint = Vector2.new(0.5, 0.5)
    thumb.Position = UDim2.new(0, 0, 0.5, 0)
    thumb.BackgroundColor3 = Color3.fromRGB(230, 230, 230)
    thumb.Parent = sliderBar
    Instance.new("UICorner", thumb).CornerRadius = UDim.new(1, 0)

    local function tweenVisual(rel)
        -- Keep the slider visual within bounds (0-1)
        local visualRel = math.clamp(rel, 0, 1)
        TweenService:Create(sliderFill, TweenInfo.new(0.15), {Size = UDim2.new(visualRel, 0, 1, 0)}):Play()
        TweenService:Create(thumb, TweenInfo.new(0.15), {Position = UDim2.new(visualRel, 0, 0.5, 0)}):Play()
    end

    local function applyValue(value)
        Settings[name] = value
        label.Text = string.format("%s: %.2f", name, value)
        textBox.Text = tostring(value)
        
        -- Calculate relative position for slider visualization (clamped to min/max for visual)
        local visualValue = math.clamp(value, min, max)
        local rel = (visualValue - min) / (max - min)
        tweenVisual(rel)

        if CurrentTrack and CurrentTrack.IsPlaying then
            if name == "Speed" then
                CurrentTrack:AdjustSpeed(Settings["Speed"])
            elseif name == "Weight" then
                local weight = Settings["Weight"]
                if weight == 0 then weight = 0.001 end
                CurrentTrack:AdjustWeight(weight)
            elseif name == "Time Position" then
                if CurrentTrack and CurrentTrack.IsPlaying and CurrentTrack.Length > 0 then
                    CurrentTrack.TimePosition = math.clamp(value, 0, 1) * CurrentTrack.Length
                end
            end
        end
    end
   
    local dragging = false
    local function updateFromInput(input)
        local relX = math.clamp((input.Position.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
        local value = math.floor((min + (max - min) * relX) * 100) / 100
        applyValue(value)
    end

    sliderBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateFromInput(input)
        end
    end)
    thumb.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateFromInput(input)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updateFromInput(input)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragging = false
        end
    end)

    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local num = tonumber(textBox.Text)
            if num then
                -- Allow values beyond the slider's visual limits
                applyValue(num)
            else
                textBox.Text = tostring(Settings[name])
            end
        end
    end)

    applyValue(Settings[name])
end

-- Toggle creator function
local function createToggle(name)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 40)
    container.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    container.Parent = scrollFrame
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, -10, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0, 60, 0, 24)
    toggleBtn.Position = UDim2.new(1, -70, 0.5, -12)
    toggleBtn.BackgroundColor3 = Settings[name] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
    toggleBtn.Text = Settings[name] and "ON" or "OFF"
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 14
    toggleBtn.Parent = container
    Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)

    toggleBtn.MouseButton1Click:Connect(function()
        Settings[name] = not Settings[name]
        if Settings[name] then
            toggleBtn.Text = "ON"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            toggleBtn.Text = "OFF"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        end
    end)
end

-- Create settings controls
createToggle("Stop On Move")
createSlider("Time Position", 0, 1, Settings["Time Position"])
createSlider("Speed", 0, 5, Settings["Speed"])
createSlider("Weight", 0, 1, Settings["Weight"])
createSlider("Fade In", 0, 2, Settings["Fade In"])
createSlider("Fade Out", 0, 2, Settings["Fade Out"])
createToggle("Allow Invisible")

-- Allow Invisible functionality
local originalCollisionStates = {}
local lastFixClipState = Settings["Allow Invisible"]

local function saveCollisionStates()
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            originalCollisionStates[part] = part.CanCollide
        end
    end
end

local function disableCollisionsExceptRootPart()
    if not Settings["Allow Invisible"] then
        return
    end
    
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            part.CanCollide = false
        end
    end
end

local function restoreCollisionStates()
    for part, canCollide in pairs(originalCollisionStates) do
        if part and part.Parent then
            part.CanCollide = canCollide
        end
    end
    originalCollisionStates = {}
end

saveCollisionStates()

local connection
connection = RunService.Stepped:Connect(function()
    if character and character.Parent then
        local currentFixClip = Settings["Allow Invisible"]
        
        if lastFixClipState ~= currentFixClip then
            if currentFixClip then
                saveCollisionStates()
                disableCollisionsExceptRootPart()
            else
                restoreCollisionStates()
            end
            lastFixClipState = currentFixClip
        elseif currentFixClip then
            disableCollisionsExceptRootPart()
        end
    else
        restoreCollisionStates()
        if connection then
            connection:Disconnect()
        end
    end
end)

player.CharacterAdded:Connect(function(newCharacter)
    restoreCollisionStates()
    character = newCharacter
    humanoid = newCharacter:WaitForChild("Humanoid")
    
    saveCollisionStates()
    lastFixClipState = Settings["Allow Invisible"]
    
    if connection then
        connection:Disconnect()
    end
    
    connection = RunService.Stepped:Connect(function()
        if character and character.Parent then
            local currentFixClip = Settings["Allow Invisible"]
            
            if lastFixClipState ~= currentFixClip then
                if currentFixClip then
                    saveCollisionStates()
                    disableCollisionsExceptRootPart()
                else
                    restoreCollisionStates()
                end
                lastFixClipState = currentFixClip
            elseif currentFixClip then
                disableCollisionsExceptRootPart()
            end
        else
            restoreCollisionStates()
            if connection then
                connection:Disconnect()
            end
        end
    end)
end)

-- === State ===
local sortModes = {
    {Enum.CatalogSortType.Relevance, "Relevance"},
    {Enum.CatalogSortType.PriceHighToLow, "Price High→Low"},
    {Enum.CatalogSortType.PriceLowToHigh, "Price Low→High"},
    {Enum.CatalogSortType.MostFavorited, "Most Favorited"},
    {Enum.CatalogSortType.RecentlyCreated, "Recently Created"},
    {Enum.CatalogSortType.Bestselling, "Bestselling"},
}
local currentSortIndex = 1
local currentKeyword = ""
local currentPages = nil
local currentPageNumber = 1

-- === Catalog fetch ===
local function getPages(keyword)
    local params = CatalogSearchParams.new()
    params.SearchKeyword = keyword or ""
    params.CategoryFilter = Enum.CatalogCategoryFilter.None
    params.SalesTypeFilter = Enum.SalesTypeFilter.All
    params.AssetTypes = { Enum.AvatarAssetType.EmoteAnimation }
    params.IncludeOffSale = true
    params.SortType = sortModes[currentSortIndex][1]
    params.Limit = 30

    local ok, pages = pcall(function()
        return AvatarEditorService:SearchCatalog(params)
    end)

    if not ok then
        warn("SearchCatalog failed:", pages)
        return nil
    end
    return pages
end

-- === Card builder ===
local function createCard(item)
    local card = Instance.new("Frame")
    card.Size = UDim2.new(0, 120, 0, 160)
    card.BackgroundColor3 = Color3.fromRGB(55, 55, 55)

    -- Apply gradient and corner to card
    createGradient(card, ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(65, 65, 65)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 45, 45))
    })
    createCorner(card, 8)

    local thumbId = item.AssetId or item.Id
    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1, -10, 0, 90)
    img.Position = UDim2.new(0, 5, 0, 5)
    img.BackgroundTransparency = 1
    img.ScaleType = Enum.ScaleType.Fit
    img.Image = "rbxthumb://type=Asset&id=" .. tostring(thumbId) .. "&w=150&h=150"
    img.Parent = card
    
    -- Apply corner to image
    createCorner(img, 6)

    local name = Instance.new("TextLabel")
    name.Size = UDim2.new(1, -10, 0, 28)
    name.Position = UDim2.new(0, 5, 0, 100)
    name.BackgroundTransparency = 1
    name.Text = item.Name or "Unknown"
    name.TextScaled = true
    name.TextWrapped = true
    name.Font = Enum.Font.GothamBold
    name.TextColor3 = Color3.new(1, 1, 1)
    name.Parent = card

    local playBtn = Instance.new("TextButton")
    playBtn.Size = UDim2.new(1, -10, 0, 24)
    playBtn.Position = UDim2.new(0, 5, 1, -29)
    playBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
    playBtn.Text = "Play"
    playBtn.Font = Enum.Font.GothamBold
    playBtn.TextScaled = true
    playBtn.TextColor3 = Color3.new(1, 1, 1)
    playBtn.Parent = card

    -- Apply gradient and corner to play button
    createGradient(playBtn, ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 200, 80)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 150, 50))
    })
    createCorner(playBtn, 6)

    playBtn.MouseButton1Click:Connect(function()
        LoadTrack(thumbId)
    end)

    return card
end

-- === Refresh display from current page ===
local function updateNavVisibility()
    -- hide prev on first page, hide next when pages says finished (if available)
    prevBtn.Visible = (currentPageNumber > 1)
    if currentPages and typeof(currentPages.IsFinished) == "boolean" then
        nextBtn.Visible = not currentPages.IsFinished
    else
        nextBtn.Visible = true
    end
end

local function showPage(pages)
    -- clear old cards (only Frames created by createCard)
    for _, child in ipairs(scroll:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end

    local currentList = nil
    -- pages:GetCurrentPage() returns a table of items
    local ok, got = pcall(function() return pages:GetCurrentPage() end)
    if ok then
        currentList = got
    else
        warn("Failed to GetCurrentPage:", got)
    end

    if currentList and #currentList > 0 then
        emptyLabel.Visible = false
        for _, item in ipairs(currentList) do
            createCard(item).Parent = scroll
        end
    else
        emptyLabel.Visible = true
    end

    -- update canvas size (UIGridLayout AbsoluteContentSize will be set after adding children)
    scroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
    pageLabel.Text = "Page " .. tostring(currentPageNumber)
    updateNavVisibility()
end

-- helper: attempt to fetch fresh pages and advance to targetPage (1-based)
local function fetchPagesTo(targetPage)
    local pages = getPages(currentKeyword)
    if not pages then return nil end
    -- already at page 1; advance until targetPage
    for i = 2, targetPage do
        -- ignore failures for individual advances; break if IsFinished
        if pages.IsFinished then break end
        local ok, err = pcall(function() pages:AdvanceToNextPageAsync() end)
        if not ok then
            -- can't advance further; break early
            break
        end
    end
    return pages
end

-- === Event handlers ===
local function doNewSearch(keyword)
    currentKeyword = keyword or ""
    currentPageNumber = 1
    searchBox.Text = "" -- Clear search box text
    currentPages = getPages(currentKeyword)
    if currentPages then
        showPage(currentPages)
    end
end

searchBtn.MouseButton1Click:Connect(function()
    doNewSearch(searchBox.Text)
end)

sortBtn.MouseButton1Click:Connect(function()
    currentSortIndex = currentSortIndex % #sortModes + 1
    sortBtn.Text = "Sort: " .. sortModes[currentSortIndex][2]
    -- when sort changes, re-run search and reset to page 1
    doNewSearch(currentKeyword)
end)

searchBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        doNewSearch(searchBox.Text)
    end
end)

nextBtn.MouseButton1Click:Connect(function()
    if not currentPages then return end

    -- If already flagged as finished, do nothing
    if currentPages.IsFinished then return end

    -- Try to advance the existing Pages object (this mutates the pages state)
    local ok, err = pcall(function()
        currentPages:AdvanceToNextPageAsync()
    end)

    if ok then
        currentPageNumber = currentPageNumber + 1
        showPage(currentPages)
    else
        warn("AdvanceToNextPageAsync failed, attempting fresh SearchCatalog fallback:", err)
        -- fallback: re-run search and try to get to the desired page
        local targetPage = currentPageNumber + 1
        local fresh = fetchPagesTo(targetPage)
        if fresh then
            currentPages = fresh
            currentPageNumber = math.min(targetPage, currentPageNumber + 1)
            showPage(currentPages)
        end
    end
end)

prevBtn.MouseButton1Click:Connect(function()
    if not currentPages then return end

    -- If already on page 1, do nothing
    if currentPageNumber <= 1 then return end

    -- Try to advance to previous page on existing Pages object
    local ok, err = pcall(function()
        currentPages:AdvanceToPreviousPageAsync()
    end)

    if ok then
        currentPageNumber = math.max(1, currentPageNumber - 1)
        showPage(currentPages)
    else
        warn("AdvanceToPreviousPageAsync failed, attempting fresh SearchCatalog fallback:", err)
        -- fallback: re-run search and advance to (currentPageNumber - 1)
        local targetPage = math.max(1, currentPageNumber - 1)
        local fresh = fetchPagesTo(targetPage)
        if fresh then
            currentPages = fresh
            currentPageNumber = targetPage
            showPage(currentPages)
        end
    end
end)

-- === Initial load ===
doNewSearch("")
